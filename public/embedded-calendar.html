<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"
    />
    <title>Embedded Booking Calendar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- Optional: Include custom CSS for styling -->
    <link
      rel="stylesheet"
      href="calendar-custom.css"
    />
    <style>
      .calendar-day {
        position: relative;
        height: 40px;
        width: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 0.25rem;
        cursor: pointer;
      }

      .calendar-day.past {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .calendar-day.admin {
        cursor: pointer;
      }

      .status-available {
        background-color: #dcfce7;
        color: #166534;
      }

      .status-booked {
        background-color: #fee2e2;
        color: #991b1b;
      }

      .status-half-booked {
        background-color: #fef3c7;
        color: #92400e;
      }
    </style>
  </head>
  <body>
    <div
      id="embedded-calendar"
      class="p-4 max-w-5xl mx-auto"
    >
      <div
        v-if="loading"
        class="flex justify-center items-center h-40"
      >
        <div
          class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"
        ></div>
      </div>

      <div v-else>
        <div class="flex justify-between items-center mb-6">
          <div class="flex items-center space-x-4">
            <button
              @click="previousYear"
              class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 flex items-center"
              :disabled="yearOffset <= 0"
              :class="{ 'opacity-50 cursor-not-allowed': yearOffset <= 0 }"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-4 w-4 mr-1"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 19l-7-7 7-7"
                />
              </svg>
            </button>

            <span class="font-medium">{{ currentYearDisplay }}</span>

            <button
              @click="nextYear"
              class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 flex items-center"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-4 w-4 ml-1"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 5l7 7-7 7"
                />
              </svg>
            </button>
          </div>
        </div>

        <div
          class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8"
        >
          <div
            v-for="(monthData, index) in months"
            :key="`${monthData.year}-${monthData.month}`"
            class="bg-white rounded-lg shadow-sm p-4"
          >
            <h3 class="text-lg font-medium mb-4">
              {{ getMonthName(new Date(monthData.year, monthData.month, 1)) }}
              {{ monthData.year }}
            </h3>

            <div class="grid grid-cols-7 gap-1 mb-2">
              <div
                v-for="day in weekDays"
                :key="day"
                class="text-xs text-center font-medium text-gray-500"
              >
                {{ day }}
              </div>
            </div>

            <div class="grid grid-cols-7 gap-1">
              <div
                v-for="(dateInfo, dateIndex) in getDatesForMonth(monthData.year, monthData.month)"
                :key="dateIndex"
                :class="[
                'calendar-day', 
                dateInfo.date ? getStatusClass(dateInfo.status) : 'opacity-0 pointer-events-none',
                { past: dateInfo.date && isPastDate(dateInfo.date) }
              ]"
                :title="dateInfo.date ? getStatusLabel(dateInfo.status) : ''"
              >
                <span
                  v-if="dateInfo.date"
                  class="text-sm"
                  >{{ dateInfo.date.getDate() }}</span
                >
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const { createApp, ref, computed } = Vue;

      const app = createApp({
        setup() {
          const yearOffset = ref(0);
          const dateStatuses = ref({});
          const loading = ref(true);
          const apiBaseUrl =
            new URL(window.location.href).searchParams.get("api") || "/api";

          const currentYearDisplay = computed(() => {
            const today = new Date();
            return today.getFullYear() + yearOffset.value;
          });

          const months = computed(() => getMonths(yearOffset.value));

          function getMonths(offset = 0) {
            const today = new Date();
            const currentYear = today.getFullYear() + offset;
            const months = [];

            for (let month = 0; month < 12; month++) {
              months.push({
                year: currentYear,
                month: month,
              });
            }

            return months;
          }

          function previousYear() {
            if (yearOffset.value > 0) {
              yearOffset.value--;
            }
          }

          function nextYear() {
            yearOffset.value++;
          }

          function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, "0");
            const day = String(date.getDate()).padStart(2, "0");
            return `${year}-${month}-${day}`;
          }

          function isPastDate(date) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            date = new Date(date);
            date.setHours(0, 0, 0, 0);
            return date < today;
          }

          function getStatusClass(status) {
            switch (status) {
              case "available":
                return "status-available";
              case "booked":
                return "status-booked";
              case "half-booked":
                return "status-half-booked";
              default:
                return "";
            }
          }

          function getStatusLabel(status) {
            switch (status) {
              case "available":
                return "Ledig";
              case "booked":
                return "Optaget";
              case "half-booked":
                return "Skifte dag";
              default:
                return "";
            }
          }

          function getMonthName(date) {
            const monthNames = [
              "Januar",
              "Februar",
              "Marts",
              "April",
              "Maj",
              "Juni",
              "Juli",
              "August",
              "September",
              "Oktober",
              "November",
              "December",
            ];
            return monthNames[date.getMonth()];
          }

          const weekDays = ["Man", "Tir", "Ons", "Tor", "Fre", "Lør", "Søn"];

          // Get dates with their statuses for a specific month
          function getDatesForMonth(year, month) {
            const date = new Date(year, month, 1);
            const dates = [];

            // Add empty slots for days before the first day of the month
            // Convert Sunday (0) to 6, and other days to day-1 to make Monday (1) the first day of the week
            let firstDayOfMonth = date.getDay();
            firstDayOfMonth = firstDayOfMonth === 0 ? 6 : firstDayOfMonth - 1;

            for (let i = 0; i < firstDayOfMonth; i++) {
              dates.push({ date: null, status: null });
            }

            // Add all days in the month
            while (date.getMonth() === month) {
              const dateString = formatDate(date);
              dates.push({
                date: new Date(date),
                status: dateStatuses.value[dateString] || "available",
              });
              date.setDate(date.getDate() + 1);
            }

            return dates;
          }

          // Fetch all date statuses on component mount
          async function fetchDates() {
            try {
              loading.value = true;
              const response = await axios.get(`${apiBaseUrl}/dates`);

              // Convert array of date objects to a map for easier lookup
              const statusMap = {};
              response.data.forEach((date) => {
                statusMap[date.date] = date.status;
              });

              dateStatuses.value = statusMap;
            } catch (error) {
              console.error("Error fetching dates:", error);
            } finally {
              loading.value = false;
            }
          }

          // Fetch dates on mount
          fetchDates();

          return {
            yearOffset,
            currentYearDisplay,
            months,
            loading,
            weekDays,
            previousYear,
            nextYear,
            getDatesForMonth,
            getStatusClass,
            getStatusLabel,
            getMonthName,
            isPastDate,
          };
        },
      });

      app.mount("#embedded-calendar");
    </script>
  </body>
</html>
